#!/bin/bash

# Modules used as of August 2019
#nneveu@cori11:~/software/opal_builds/nersc/src/build> module list -l          
#- Package -----------------------------+- Versions -+- Last mod. ------      
#Currently Loaded Modulefiles:                                                
#modules/3.2.11.1                                     2018/10/25 20:23:19   
#nsg/1.2.0                                            2015/09/25 10:52:33   
#intel/19.0.3.199                                     2019/06/27 18:18:57   
#craype-network-aries                                 2019/06/27 18:13:12   
#craype/2.5.18                                        2019/06/27 18:13:12   
#cray-libsci/19.02.1                                  2019/06/27 18:25:36   
#udreg/2.3.2-7.0.0.1_4.23__g8175d3d.ari               2019/06/26 14:28:53   
#ugni/6.0.14.0-7.0.0.1_7.25__ge78e5b0.ar              2019/06/22  8:34:11   
#pmi/5.0.14                                           2019/06/27 18:23:56   
#dmapp/7.1.1-7.0.0.1_5.15__g25e5077.ari               2019/06/26 14:30:09   
#gni-headers/5.0.12.0-7.0.0.1_7.30__g3b1              2019/06/22  8:30:37   
#xpmem/2.2.17-7.0.0.1_3.20__g7acee3a.ari              2019/06/22  9:10:13   
#job/2.2.4-7.0.0.1_3.26__g36b56f4.ari                 2019/06/22  8:31:57   
#dvs/2.11_2.2.131-7.0.0.1_7.3__gd2a05f7e              2019/06/22  9:04:12   
#alps/6.6.50-7.0.0.1_3.30__g962f7108.ari              2019/06/22  9:10:53   
#rca/2.2.20-7.0.0.1_4.29__g8e3fb5b.ari                2019/06/22  8:50:02   
#atp/2.1.3                                            2019/06/27 18:24:05   
#PrgEnv-intel/6.0.5                                   2019/06/28 22:43:51   
#craype-haswell                                       2019/06/27 18:13:12   
#cray-mpich/7.7.6                                     2019/06/27 18:26:54   
#craype-hugepages2M                                   2019/06/27 18:13:12   
#gsl/2.5                                              2019/07/30 22:55:35   
#altd/2.0                                             2019/07/29 23:42:44   
#cmake/3.14.4                                         2019/07/25 23:27:47   
#boost/1.70.0                                         2019/07/30 16:58:09   
#cray-hdf5-parallel/1.10.2.0                          2019/06/27 18:24:31   
#nneveu@cori11:~/software/opal_builds/nersc/src/build>                      
#

export XTPE_LINK_TYPE=dynamic
export CRAYPE_LINK_TYPE=dynamic

#module switch PrgEnv-intel PrgEnv-gnu
#1. Load dependancies (software that opal needs):
module load cmake 
module remove darshan
module load cray-hdf5-parallel
#module load h5hut-parallel #Using H5hut build from nersc 
module load gsl   
module load boost  
#module load switch gcc/8.2.0 gcc/7.3.0 #/6.1.0 #This version needed for specific c++11 support?

export SOFTWARE="/global/homes/n/nneveu/software"
export PATH="$SOFTWARE/H5hut-2.0.0rc4_intel/:${PATH}"   
export H5HUT_HOME="/global/homes/n/nneveu/software/H5hut-2.0.0rc4_intel"
export H5HUT_PREFIX=$H5HUT_HOME
export H5HUT_DIR=$H5HUT_HOME
export H5HUT_INCLUDE_DIR=$H5HUT_HOME/include
export H5HUT_LIBRARY_DIR=$H5HUT_HOME/lib

#export BOOST_HOME=$SOFTWARE/boost-1.68
#export BOOST_DIR=$BOOST_HOME
#export BOOST_PREFIX=$BOOST_HOME
#export BOOST_INCLUDE_DIR=$BOOST_HOME/include
#export BOOST_LIBRARY_DIR=$BOOST_HOME/lib
#export BOOST_ROOT=$NHOME/boost_1_62_0_build/

#2. Point to the cray compiler wrappers (icc and icpc)
I_MPI_CC=cc;I_MPI_CXX=CC;I_MPI_F90=ftn;I_MPI_F77=ftn
export I_MPI_CC I_MPI_CXX I_MPI_F90 I_MPI_F77
#
CC=cc;CXX=CC;F90=ftn;F77=ftn
export CC CXX F90 F77

#Note: Steps #1 and #2 can be done by sourcing this file: 
# > source opal_build_cori

#Steps #3-6 should be done on the command line:

#3. Download a copy of the opal source code.
#This step can be skipped if you already have a copy of the opal src.
# > git clone https://gitlab.psi.ch/OPAL/src.git

#3.b If you have a copy of src already, make sure it is up to date
# > cd /src
# > git pull #(while in the opal /src directory)

#4. Make a build directory in the opal src directory
# > mkdir build #(while in /src from step #3.b)
# > cd build 

#Note: this directory will stay in place indefinitely.
# If you build opal again, you do not need to make a new build directory.
# Before a second build, I recommend taring the build dir (with a date in the name), 
# move the tarfile somewhere safe (storage), then delete the build dir contents.
# This way cmake will save files to an empty directory every time.

#5. Run cmake to configure build
# Note: change the path to where you want the opal executable to be installed
#cmake -DCMAKE_INSTALL_PREFIX=/home/neveu/software .. 

#6. Run make and install to generate executables
# > make -j 8 
# > make install

####################################################################
###################################################################

